name: Publish to VSCode Marketplace

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (use for hotfixes only)'
        required: false
        type: boolean
        default: false

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate tag format
      id: validate
      run: |
        TAG_NAME="${GITHUB_REF#refs/tags/}"
        echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT

        if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
          echo "Error: Tag must follow format v{major}.{minor}.{patch} or v{major}.{minor}.{patch}-{prerelease}"
          echo "Examples: v1.0.0, v1.0.0-beta.1"
          echo "Got: $TAG_NAME"
          exit 1
        fi

        VERSION=${TAG_NAME#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "✓ Valid tag format: $TAG_NAME (version: $VERSION)"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Verify tests pass
      if: github.event.inputs.skip_tests != 'true'
      run: |
        echo "Running tests before publishing..."
        npm run compile-tests
        xvfb-run -a npm test
      env:
        VSCODE_TEST_TIMEOUT: 120000

    - name: Update package.json version
      run: |
        VERSION=${{ steps.validate.outputs.version }}
        echo "Updating package.json to version $VERSION"
        npm version $VERSION --no-git-tag-version --allow-same-version

    - name: Build extension
      run: npm run vscode:prepublish

    - name: Package extension
      run: npm run vsce:package

    - name: Verify VSIX was created
      run: |
        VSIX_FILE="qiskit-vscode-${{ steps.validate.outputs.version }}.vsix"
        if [ ! -f "$VSIX_FILE" ]; then
          echo "Error: VSIX file not found: $VSIX_FILE"
          ls -la *.vsix || echo "No VSIX files found"
          exit 1
        fi
        echo "✓ VSIX created: $VSIX_FILE ($(du -h "$VSIX_FILE" | cut -f1))"

    - name: Publish to VSCode Marketplace
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
      run: |
        echo "Publishing extension to VSCode Marketplace..."
        npx vsce publish -p "$VSCE_PAT"
        echo "✓ Successfully published to marketplace"

    - name: Upload VSIX as release asset
      uses: shogo82148/actions-upload-release-asset@v1
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./qiskit-vscode-${{ steps.validate.outputs.version }}.vsix
        asset_name: qiskit-vscode-${{ steps.validate.outputs.version }}.vsix
        asset_content_type: application/zip

    - name: Create release summary
      if: success()
      run: |
        cat << EOF >> $GITHUB_STEP_SUMMARY
        ## ✅ Release Published Successfully

        - **Version**: ${{ steps.validate.outputs.version }}
        - **Tag**: ${{ steps.validate.outputs.tag }}
        - **VSIX File**: qiskit-vscode-${{ steps.validate.outputs.version }}.vsix
        - **Marketplace**: Published ✓
        - **Release Asset**: Uploaded ✓

        The extension is now available on the [VSCode Marketplace](https://marketplace.visualstudio.com/items?itemName=Qiskit.qiskit-vscode).
        EOF

    - name: Report failure
      if: failure()
      run: |
        cat << EOF >> $GITHUB_STEP_SUMMARY
        ## ❌ Release Publishing Failed

        - **Version**: ${{ steps.validate.outputs.version }}
        - **Tag**: ${{ steps.validate.outputs.tag }}

        Please check the workflow logs for details and try again.
        You can manually publish using:
        \`\`\`bash
        npm run vsce:package
        npx vsce publish
        \`\`\`
        EOF
